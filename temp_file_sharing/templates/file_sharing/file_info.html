{% extends 'base.html' %}

{% block title %}اطلاعات فایل - {{ temp_file.original_filename }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    اطلاعات فایل
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>{{ temp_file.original_filename }}</h5>
                        <p class="text-muted mb-1">
                            <i class="fas fa-hdd me-1"></i>
                            اندازه: {{ temp_file.get_human_readable_size }}
                        </p>
                        <p class="text-muted mb-1">
                            <i class="fas fa-clock me-1"></i>
                            آپلود شده: {{ temp_file.created_at|date:"Y/m/d H:i" }}
                        </p>
                        <p class="text-muted mb-3">
                            <i class="fas fa-hourglass-end me-1"></i>
                            انقضا: {{ temp_file.expires_at|date:"Y/m/d H:i" }}
                        </p>
                        
                        <!-- Download Progress -->
                        <div class="mb-3">
                            <label class="form-label">تعداد دانلود:</label>
                            <div class="progress progress-custom">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: '{{ download_percentage }}%';">
                                    {{ temp_file.download_count }}/{{ temp_file.max_downloads }}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Time Remaining -->
                        <div class="alert alert-info" id="time-remaining">
                            <i class="fas fa-clock me-2"></i>
                            <span id="countdown">محاسبه زمان باقی‌مانده...</span>
                        </div>
                    </div>
                    
                    <div class="col-md-4 text-center">
                        <div class="mb-3">
                            <i class="fas fa-file fa-4x text-primary"></i>
                        </div>
                        
                        <a href="{% url 'download_file' temp_file.share_token %}" 
                           class="btn btn-primary btn-lg mb-2" id="download-btn">
                            <i class="fas fa-download me-2"></i>
                            دانلود فایل
                        </a>
                        
                        <button class="btn btn-outline-secondary btn-sm" 
                                onclick="copyToClipboard('{{ share_url }}')">
                            <i class="fas fa-copy me-1"></i>
                            کپی لینک
                        </button>
                    </div>
                </div>
                
                <!-- Share URL -->
                <div class="mt-4">
                    <label class="form-label">لینک اشتراک‌گذاری:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="{{ share_url }}" 
                               id="share-url" readonly>
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="copyToClipboard('{{ share_url }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- QR Code (optional) -->
        <div class="card mt-4 shadow">
            <div class="card-body text-center">
                <h6>QR Code برای اشتراک‌گذاری سریع:</h6>
                <div id="qrcode" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
$(document).ready(function() {
    // Generate QR Code
    QRCode.toCanvas(document.getElementById('qrcode'), '{{ share_url }}', {
        width: 200,
        height: 200
    });
    
    // Countdown timer
    const expiresAt = new Date('{{ temp_file.expires_at.isoformat }}');
    
    function updateCountdown() {
        const now = new Date();
        const diff = expiresAt - now;
        
        if (diff <= 0) {
            $('#countdown').text('این فایل منقضی شده است');
            $('#download-btn').prop('disabled', true).removeClass('btn-primary').addClass('btn-danger');
            return;
        }
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        $('#countdown').text(`${hours} ساعت، ${minutes} دقیقه و ${seconds} ثانیه باقی مانده`);
    }
    
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
    // Auto-refresh file status
    setInterval(function() {
        $.get(`/api/status/{{ temp_file.share_token }}/`)
            .done(function(data) {
                if (data.status === 'success') {
                    const fileData = data.data;
                    if (fileData.is_expired) {
                        location.reload();
                    }
                    
                    // Update download count
                    const percentage = (fileData.download_count / fileData.max_downloads) * 100;
                    $('.progress-bar').css('width', percentage + '%')
                                     .text(`${fileData.download_count}/${fileData.max_downloads}`);
                }
            });
    }, 10000); // Check every 10 seconds
});

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Show success message
        const alert = $(`
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                لینک با موفقیت کپی شد!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('main .container').prepend(alert);
        
        setTimeout(() => alert.alert('close'), 3000);
    }).catch(function(err) {
        console.error('Could not copy text: ', err);
        
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        alert('لینک کپی شد!');
    });
}
</script>
{% endblock %}
